# Docker Compose for contextd e2e and user simulation tests
# Usage: docker compose -f test/docker-compose.test.yml up --build

services:
  # Qdrant vector database for production-like tests
  qdrant:
    image: qdrant/qdrant:v1.12.1
    container_name: contextd-test-qdrant
    ports:
      - "16333:6333"  # REST API (offset to avoid conflicts)
      - "16334:6334"  # gRPC API
    volumes:
      - qdrant-test-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c 'echo > /dev/tcp/localhost/6333' 2>/dev/null || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - contextd-test

  # Test runner container
  test-runner:
    build:
      context: ..
      dockerfile: test/Dockerfile.test
    container_name: contextd-test-runner
    depends_on:
      qdrant:
        condition: service_healthy
    environment:
      - CONTEXTD_VECTORSTORE_PROVIDER=qdrant
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6334
      - TEST_SUITES=${TEST_SUITES:-all}
      - VERBOSE=${VERBOSE:-true}
    volumes:
      - test-results:/results
    networks:
      - contextd-test

  # User simulation container (optional, for stress testing)
  user-sim:
    build:
      context: ..
      dockerfile: test/Dockerfile.test
    container_name: contextd-user-sim
    depends_on:
      qdrant:
        condition: service_healthy
    environment:
      - CONTEXTD_VECTORSTORE_PROVIDER=qdrant
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6334
      - SIM_DEVELOPERS=${SIM_DEVELOPERS:-3}
      - SIM_DURATION=${SIM_DURATION:-60s}
    command: ["/bin/sh", "-c", "/test/scripts/run-user-simulation.sh"]
    networks:
      - contextd-test
    profiles:
      - simulation

networks:
  contextd-test:
    driver: bridge

volumes:
  qdrant-test-data:
    name: contextd-test-qdrant-data
  test-results:
    name: contextd-test-results
