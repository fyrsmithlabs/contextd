name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Run nightly at 2 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: axyzlabs-runners
    timeout-minutes: 30

    services:
      milvus:
        image: milvusdb/milvus:v2.4.0
        env:
          ETCD_USE_EMBED: "true"
          ETCD_DATA_DIR: /var/lib/milvus/etcd
          COMMON_STORAGETYPE: local
        ports:
          - 19530:19530
          - 9091:9091
        options: >-
          --health-cmd "curl -f http://localhost:9091/healthz"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true

      - name: Start TEI service
        run: |
          docker run -d \
            --name tei-test \
            -p 8080:8080 \
            -v $HOME/.cache/huggingface:/data \
            ghcr.io/huggingface/text-embeddings-inference:cpu-1.2 \
            --model-id BAAI/bge-small-en-v1.5 \
            --port 8080 \
            --max-batch-tokens 16384 \
            --max-client-batch-size 512 \
            --auto-truncate

      - name: Wait for services to be ready
        run: |
          echo "Waiting for Milvus..."
          timeout 60 bash -c 'until curl -f http://localhost:9091/healthz 2>/dev/null; do echo "Waiting..."; sleep 2; done'
          echo "✓ Milvus ready"

          echo "Waiting for TEI..."
          timeout 120 bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do echo "Waiting..."; sleep 2; done'
          echo "✓ TEI ready"

      - name: Download dependencies
        run: go mod download

      - name: Run integration tests
        env:
          MILVUS_HOST: localhost
          MILVUS_PORT: 19530
          TEI_BASE_URL: http://localhost:8080
          TEI_MODEL: BAAI/bge-small-en-v1.5
          INTEGRATION_TIMEOUT: 120s
        run: |
          go test -v -race -tags=integration -timeout 20m ./test/integration/...

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Milvus Health ==="
          curl -f http://localhost:9091/healthz || echo "Milvus not responding"

          echo "=== TEI Health ==="
          curl -f http://localhost:8080/health || echo "TEI not responding"

          echo "=== TEI Logs ==="
          docker logs tei-test || echo "TEI logs not available"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: integration-test-results
          path: |
            *.out
            *.log

  integration-tests-macos:
    name: Integration Tests (macOS)
    runs-on: axyzlabs-runners
    timeout-minutes: 30
    # Only run on manual trigger or scheduled runs
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true

      - name: Install Docker (macOS)
        run: |
          brew install docker docker-compose
          brew install colima
          colima start --cpu 2 --memory 4

      - name: Start test services
        run: |
          docker-compose -f test/docker-compose.test.yml up -d

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:9091/healthz 2>/dev/null; do sleep 2; done'
          timeout 120 bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do sleep 2; done'

      - name: Run integration tests
        run: |
          go test -v -race -tags=integration -timeout 20m ./test/integration/...

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f test/docker-compose.test.yml down -v
          colima stop

  benchmark:
    name: Integration Benchmarks
    runs-on: axyzlabs-runners
    timeout-minutes: 20
    # Only run on manual trigger or main branch
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    services:
      milvus:
        image: milvusdb/milvus:v2.4.0
        env:
          ETCD_USE_EMBED: "true"
          ETCD_DATA_DIR: /var/lib/milvus/etcd
          COMMON_STORAGETYPE: local
        ports:
          - 19530:19530
          - 9091:9091
        options: >-
          --health-cmd "curl -f http://localhost:9091/healthz"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true

      - name: Start TEI service
        run: |
          docker run -d \
            --name tei-test \
            -p 8080:8080 \
            ghcr.io/huggingface/text-embeddings-inference:cpu-1.2 \
            --model-id BAAI/bge-small-en-v1.5 \
            --port 8080

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:9091/healthz 2>/dev/null; do sleep 2; done'
          timeout 120 bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do sleep 2; done'

      - name: Run benchmarks
        run: |
          go test -v -tags=integration -bench=. -benchmem -benchtime=10s ./test/integration/... | tee benchmark.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v5
        with:
          name: benchmark-results
          path: benchmark.txt

      - name: Compare with previous benchmarks
        if: github.event_name == 'pull_request'
        run: |
          echo "Benchmark comparison would go here"
          # Future: Compare with baseline benchmarks

  coverage:
    name: Integration Test Coverage
    runs-on: axyzlabs-runners
    timeout-minutes: 30

    services:
      milvus:
        image: milvusdb/milvus:v2.4.0
        env:
          ETCD_USE_EMBED: "true"
          ETCD_DATA_DIR: /var/lib/milvus/etcd
          COMMON_STORAGETYPE: local
        ports:
          - 19530:19530
          - 9091:9091
        options: >-
          --health-cmd "curl -f http://localhost:9091/healthz"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          cache: true

      - name: Start TEI service
        run: |
          docker run -d \
            --name tei-test \
            -p 8080:8080 \
            ghcr.io/huggingface/text-embeddings-inference:cpu-1.2 \
            --model-id BAAI/bge-small-en-v1.5 \
            --port 8080

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:9091/healthz 2>/dev/null; do sleep 2; done'
          timeout 120 bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do sleep 2; done'

      - name: Run tests with coverage
        run: |
          go test -v -race -tags=integration -coverprofile=integration-coverage.out -covermode=atomic ./test/integration/...

      - name: Generate coverage report
        run: |
          go tool cover -html=integration-coverage.out -o integration-coverage.html
          go tool cover -func=integration-coverage.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./integration-coverage.out
          flags: integration
          name: integration-tests

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v5
        with:
          name: integration-coverage
          path: |
            integration-coverage.out
            integration-coverage.html
