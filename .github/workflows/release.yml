name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # Build Linux binaries using goreleaser-cross
  build-linux:
    runs-on: ubuntu-latest
    env:
      CGO_ENABLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ONNX Runtime
        env:
          ONNX_VERSION: "1.23.2"
        run: |
          cd /tmp
          wget -q "https://github.com/microsoft/onnxruntime/releases/download/v${ONNX_VERSION}/onnxruntime-linux-x64-${ONNX_VERSION}.tgz"
          tar xzf "onnxruntime-linux-x64-${ONNX_VERSION}.tgz"
          sudo cp onnxruntime-linux-x64-${ONNX_VERSION}/lib/*.so* /usr/local/lib/
          sudo ldconfig

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --skip=publish --config .goreleaser-linux.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: dist/*.tar.gz

  # Build macOS binaries on native runners
  build-macos:
    strategy:
      matrix:
        include:
          - runner: macos-13
            goarch: amd64
          - runner: macos-14
            goarch: arm64
    runs-on: ${{ matrix.runner }}
    env:
      CGO_ENABLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install ONNX Runtime
        run: brew install onnxruntime

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build binaries
        env:
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          mkdir -p dist
          go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/contextd ./cmd/contextd
          go build -ldflags="-s -w -X main.version=${VERSION}" -o dist/ctxd ./cmd/ctxd

      - name: Create archive
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          cd dist
          cp ../README.md ../LICENSE* . 2>/dev/null || true
          tar czf "contextd_${VERSION}_darwin_${GOARCH}.tar.gz" contextd ctxd README.md LICENSE* 2>/dev/null || tar czf "contextd_${VERSION}_darwin_${GOARCH}.tar.gz" contextd ctxd README.md

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-darwin-${{ matrix.goarch }}
          path: dist/*.tar.gz

  # Create release with all artifacts
  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: dist-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate checksums
        working-directory: artifacts
        run: |
          sha256sum contextd_* > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --generate-notes \
            artifacts/*

      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          # Get source tarball SHA
          SOURCE_SHA=$(curl -sL "https://github.com/fyrsmithlabs/contextd/archive/refs/tags/v${VERSION}.tar.gz" | sha256sum | cut -d' ' -f1)

          # Generate formula
          FORMULA=$(cat << EOF
          # typed: false
          # frozen_string_literal: true

          class Contextd < Formula
            desc "AI context and reasoning engine for Claude Code"
            homepage "https://github.com/fyrsmithlabs/contextd"
            version "${VERSION}"
            license "MIT"

            url "https://github.com/fyrsmithlabs/contextd/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SOURCE_SHA}"

            depends_on "go" => :build
            depends_on "onnxruntime"

            def install
              ENV["CGO_ENABLED"] = "1"

              ldflags = %W[
                -s -w
                -X main.version=#{version}
              ]

              system "go", "build", *std_go_args(ldflags:), "-o", bin/"contextd", "./cmd/contextd"
              system "go", "build", *std_go_args(ldflags:), "-o", bin/"ctxd", "./cmd/ctxd"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/contextd --version")
              assert_match version.to_s, shell_output("#{bin}/ctxd --version")
            end
          end
          EOF
          )

          # Get current file SHA
          FILE_SHA=$(gh api repos/fyrsmithlabs/homebrew-tap/contents/Formula/contextd.rb --jq '.sha')

          # Update formula
          gh api repos/fyrsmithlabs/homebrew-tap/contents/Formula/contextd.rb \
            -X PUT \
            -f message="chore: update contextd formula to v${VERSION}" \
            -f content="$(echo "$FORMULA" | base64 -w0)" \
            -f sha="$FILE_SHA"

  # Build and push Docker image
  docker:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/fyrsmithlabs/contextd:${{ steps.version.outputs.VERSION }}
            ghcr.io/fyrsmithlabs/contextd:latest
          labels: |
            org.opencontainers.image.title=contextd
            org.opencontainers.image.description=AI context and reasoning engine for Claude Code
            org.opencontainers.image.version=${{ steps.version.outputs.VERSION }}
            org.opencontainers.image.source=https://github.com/fyrsmithlabs/contextd
          cache-from: type=gha
          cache-to: type=gha,mode=max
