name: Go Test Matrix

on:
  push:
    branches: [main, develop]
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/go-test-matrix.yml"

permissions:
  contents: read
  pull-requests: write
  checks: write
  id-token: write

jobs:
  test-matrix:
    name: Test (Go ${{ matrix.go-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Simplified matrix - just latest Go version on self-hosted
        go-version: ["1.25.3"]
        os: [axzyzlabs-runners]
        include:
          # Add specific test configurations
          - go-version: "1.25.3"
            os: self-hosted
            upload-coverage: true

    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v6.pre.beta
        with:
          fetch-depth: 0

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: |
            go.sum
            go.mod

      - name: Cache Go build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go-version }}-
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: |
          go mod download
          go mod verify

      - name: Run tests with race detector
        if: matrix.os != 'self-hosted'
        env:
          CGO_ENABLED: 1 # Required for race detector
        run: |
          go test -race -coverprofile=coverage.out -covermode=atomic -parallel 4 ./... -v -timeout 10m

      - name: Run tests (without race detector)
        if: matrix.os == 'self-hosted'
        run: |
          go test -coverprofile=coverage.out -covermode=atomic -parallel 4 ./... -v -timeout 10m

      - name: Calculate coverage
        id: coverage
        if: matrix.upload-coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Total coverage: ${COVERAGE}%"

          # Check minimum threshold
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "❌ Coverage ${COVERAGE}% is below 80% threshold"
            exit 1
          fi
          echo "✅ Coverage ${COVERAGE}% meets 80% threshold"

      - name: Generate coverage report
        if: matrix.upload-coverage
        run: |
          go tool cover -func=coverage.out | tee coverage-report.txt
          echo ""
          echo "=== Package Coverage Summary ==="
          go tool cover -func=coverage.out | grep -E '^total:' || true

      - name: Upload coverage to Codecov
        if: matrix.upload-coverage
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.0.7
        with:
          files: ./coverage.out
          flags: unittests,go-${{ matrix.go-version }}
          name: codecov-go-${{ matrix.go-version }}
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

      - name: Upload coverage artifacts
        if: matrix.upload-coverage
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: coverage-go-${{ matrix.go-version }}-${{ matrix.os }}
          path: |
            coverage.out
            coverage-report.txt
          retention-days: 30

      - name: Run benchmarks
        if: matrix.go-version == '1.25.3' && matrix.os == 'self-hosted'
        run: |
          go test -bench=. -benchmem -run=^$ ./... | tee benchmark-results.txt

      - name: Upload benchmark results
        if: matrix.go-version == '1.25.3' && matrix.os == 'self-hosted'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: benchmark-results
          path: benchmark-results.txt
          retention-days: 30

  quality-gates:
    name: Quality Gates
    runs-on: axyzlabs-runners
    needs: test-matrix

    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v6.pre.beta

      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: "1.25.3"
          cache: true

      - name: Verify no +build tags
        run: |
          if grep -r "// +build" --include="*.go" .; then
            echo "❌ Found deprecated +build tags. Use //go:build instead"
            exit 1
          fi
          echo "✅ No deprecated build tags found"

      - name: Check gofmt
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "❌ Code is not formatted. Run: gofmt -w ."
            gofmt -l .
            exit 1
          fi
          echo "✅ Code is properly formatted"

      - name: Check for test files
        run: |
          echo "Checking that all Go packages have tests..."
          PACKAGES=$(find . -name "*.go" -not -name "*_test.go" -not -path "./vendor/*" -exec dirname {} \; | sort -u)

          MISSING_TESTS=0
          for pkg in $PACKAGES; do
            if [[ "$pkg" == *"/cmd/"* ]]; then
              continue
            fi

            if ! ls "$pkg"/*_test.go 1> /dev/null 2>&1; then
              echo "⚠️  WARNING: No test files in $pkg"
              MISSING_TESTS=$((MISSING_TESTS + 1))
            fi
          done

          if [ $MISSING_TESTS -gt 0 ]; then
            echo "❌ Found $MISSING_TESTS packages without tests"
            exit 1
          fi
          echo "✅ All packages have test files"

      - name: Run go vet
        run: |
          go vet ./...
          echo "✅ go vet passed"

      - name: Check go mod tidy
        run: |
          go mod tidy
          if ! git diff --exit-code go.mod go.sum; then
            echo "❌ go.mod or go.sum needs tidying. Run: go mod tidy"
            exit 1
          fi
          echo "✅ go.mod and go.sum are tidy"
