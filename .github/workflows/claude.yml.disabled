name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false # Let Claude complete its work

jobs:
  claude:
    # Security: Only run for collaborators/members/owners to prevent abuse
    if: |
      (
        (github.event_name == 'issue_comment' &&
         contains(github.event.comment.body, '@claude') &&
         (github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'))
        ||
        (github.event_name == 'pull_request_review_comment' &&
         contains(github.event.comment.body, '@claude') &&
         (github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'))
        ||
        (github.event_name == 'pull_request_review' &&
         contains(github.event.review.body, '@claude') &&
         (github.event.review.author_association == 'OWNER' ||
          github.event.review.author_association == 'MEMBER' ||
          github.event.review.author_association == 'COLLABORATOR'))
        ||
        (github.event_name == 'issues' &&
         (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')) &&
         (github.event.issue.author_association == 'OWNER' ||
          github.event.issue.author_association == 'MEMBER' ||
          github.event.issue.author_association == 'COLLABORATOR'))
      )
    runs-on: axyzlabs-runners
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Dependencies
        uses: ./.github/actions/setup-dependencies
        with:
          setup-python: 'true'

      - name: Prepare generic prompt
        id: prompt
        env:
          EVENT_JSON: ${{ toJSON(github.event) }}
          REPOSITORY: ${{ github.repository }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          template = Path('.claude/prompts/claude-generic.md').read_text()
          event = json.loads(os.environ['EVENT_JSON'])
          repository = os.environ['REPOSITORY']
          event_name = os.environ['EVENT_NAME']

          def extract_request(evt: dict) -> str:
              if not isinstance(evt, dict):
                  return ''

              comment = evt.get('comment')
              if isinstance(comment, dict):
                  body = comment.get('body')
                  if body:
                      return str(body)

              review = evt.get('review')
              if isinstance(review, dict):
                  body = review.get('body')
                  if body:
                      return str(body)

              issue = evt.get('issue')
              if isinstance(issue, dict):
                  body = issue.get('body')
                  if body:
                      return str(body)
                  title = issue.get('title')
                  if title:
                      return str(title)

              return ''

          request_body = extract_request(event).strip()

          content = (template
                     .replace('{{ repository }}', repository)
                     .replace('{{ event_type }}', event_name)
                     .replace('{{ trigger_context }}', '@claude mentioned')
                     .replace('{{ request_body }}', request_body))

          output_path = os.environ.get('GITHUB_OUTPUT')
          if not output_path:
              raise SystemExit('GITHUB_OUTPUT environment variable is required')

          delimiter = 'CLAUDE_PROMPT'

          with open(output_path, 'a', encoding='utf-8') as fh:
              fh.write(f'content<<{delimiter}\n')
              fh.write(content)
              fh.write(f'\n{delimiter}\n')
          PY

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Use pre-defined prompt that references project config and agents
          prompt: ${{ steps.prompt.outputs.content }}

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          # claude_args: '--allowed-tools Bash(gh pr:*)'
