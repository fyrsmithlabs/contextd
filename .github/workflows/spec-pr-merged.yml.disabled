name: Spec PR Merged

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  update-labels:
    # Only run if PR was merged (not just closed) and has ai:spec-created label
    if: >
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'ai:spec-created')

    runs-on: axyzlabs-runners
    timeout-minutes: 5

    steps:
      - name: Extract issue number from PR
        id: extract-issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Try to extract issue number from "Closes #123" in PR body
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oP 'Closes #\K\d+' | head -1)

          # If not found in body, try PR title
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(echo "$PR_TITLE" | grep -oP '#\K\d+' | head -1)
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âŒ Could not extract issue number from PR"
            exit 1
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "Found issue number: $ISSUE_NUMBER"

      - name: Update issue labels
        env:
          ISSUE_NUMBER: ${{ steps.extract-issue.outputs.issue_number }}
          REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Updating labels for issue #$ISSUE_NUMBER after spec PR merge"

          # Remove ai:needs-spec label
          gh issue edit $ISSUE_NUMBER --repo "$REPOSITORY" --remove-label "ai:needs-spec" 2>/dev/null || echo "Label ai:needs-spec not found or already removed"

          # Remove ai:spec-created label (PR now merged)
          gh issue edit $ISSUE_NUMBER --repo "$REPOSITORY" --remove-label "ai:spec-created" 2>/dev/null || echo "Label ai:spec-created not found or already removed"

          # Add ai:spec-complete label
          gh issue edit $ISSUE_NUMBER --repo "$REPOSITORY" --add-label "ai:spec-complete" || echo "Failed to add ai:spec-complete label"

          echo "âœ… Labels updated successfully"
          echo "   Removed: ai:needs-spec, ai:spec-created"
          echo "   Added: ai:spec-complete"

      - name: Comment on issue
        env:
          ISSUE_NUMBER: ${{ steps.extract-issue.outputs.issue_number }}
          REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY="âœ… **Specification completed and merged**

          The specification for this issue has been reviewed and merged in PR #${PR_NUMBER}.

          **Next Steps**:
          1. Review the specification in \`docs/specs/\`
          2. Break down into implementation tasks
          3. Begin implementation following the spec

          **Links**:
          - Specification PR: ${PR_URL}
          - Merged Specs: [View in Repository](https://github.com/${REPOSITORY}/tree/main/docs/specs)

          ---
          ðŸ¤– Automated by Spec PR Merged Workflow"

          gh issue comment $ISSUE_NUMBER --repo "$REPOSITORY" --body "$COMMENT_BODY"

          echo "âœ… Comment added to issue #$ISSUE_NUMBER"
