name: Auto-Fix Review Findings

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: false # Let fixes complete

jobs:
  handle-review:
    runs-on: axyzlabs-runners
    timeout-minutes: 15

    steps:
      - name: Check review type
        id: check-review
        env:
          REVIEW_STATE: ${{ github.event.review.state }}
          REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          echo "Review state: $REVIEW_STATE"
          echo "review_state=$REVIEW_STATE" >> $GITHUB_OUTPUT

          # Check if review has findings (CHANGES_REQUESTED or specific keywords)
          if [ "$REVIEW_STATE" = "changes_requested" ] || echo "$REVIEW_BODY" | grep -qiE "(issues? found|fix required|must address)"; then
            echo "has_findings=true" >> $GITHUB_OUTPUT
            echo "‚úã Review has findings that need fixing"
          else
            echo "has_findings=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Review has no findings"
          fi

      - name: Setup Dependencies
        if: steps.check-review.outputs.has_findings == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup gh CLI
        if: steps.check-review.outputs.has_findings == 'true'
        uses: ./.github/actions/setup-dependencies
        with:
          setup-gh-cli: 'true'

      - name: Trigger opencode via comment
        if: steps.check-review.outputs.has_findings == 'true'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          echo "üìù Posting /opencode comment to trigger auto-fix..."

          # Get PR details for context
          PR_TITLE=$(gh pr view $PR_NUMBER --repo $REPOSITORY --json title \
            -q '.title')
          PR_AUTHOR=$(gh pr view $PR_NUMBER --repo $REPOSITORY --json author \
            -q '.author.login')
          HEAD_REF=$(gh pr view $PR_NUMBER --repo $REPOSITORY --json headRefName \
            -q '.headRefName')

          # Create comprehensive comment for opencode
          COMMENT_BODY=$(cat <<EOF
          /opencode please address the code review findings and fix all issues

          ## Context
          - **PR**: #${PR_NUMBER} - ${PR_TITLE}
          - **Author**: @${PR_AUTHOR}
          - **Branch**: ${HEAD_REF}
          - **Review Status**: Changes Requested

          ## Code Review Findings

          ${REVIEW_BODY}

          ## Instructions

          Please:
          1. Read the code review comments above carefully
          2. Fix all issues identified in the review
          3. Ensure all tests pass
          4. Follow project coding standards in CLAUDE.md
          5. Maintain test coverage ‚â•80%
          6. Run pre-commit hooks before committing

          After fixes are applied, the review workflow will re-run automatically.

          ü§ñ Auto-triggered by review findings detection
          EOF
          )

          gh pr comment $PR_NUMBER --repo $REPOSITORY --body "$COMMENT_BODY"

          echo "‚úÖ opencode triggered via comment"
          echo "üîÑ The opencode workflow will now run and address the issues"

  auto-merge-if-approved:
    needs: [handle-review]
    if: github.event.review.state == 'approved'
    runs-on: axyzlabs-runners
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Dependencies
        uses: ./.github/actions/setup-dependencies
        with:
          setup-gh-cli: 'true'

      - name: Check if PR is ready to merge
        id: check-ready
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking if PR #$PR_NUMBER is ready to merge..."

          # Get PR review state
          REVIEW_STATE=$(gh pr view $PR_NUMBER --repo $REPOSITORY --json reviewDecision -q '.reviewDecision')
          echo "Review state: $REVIEW_STATE"

          # Get check status
          HEAD_SHA=$(gh pr view $PR_NUMBER --repo $REPOSITORY --json headRefOid -q '.headRefOid')
          CHECK_RUNS=$(gh api "/repos/$REPOSITORY/commits/$HEAD_SHA/check-runs" \
            --jq '[.check_runs[] | select(.status != "completed" or .conclusion != "success")] | length')
          echo "Failing or pending checks: $CHECK_RUNS"

          # Check if ready
          if [ "$REVIEW_STATE" = "APPROVED" ] && [ "$CHECK_RUNS" = "0" ]; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR is ready to merge"
          else
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "‚è≥ PR not ready:"
            echo "  - Review: $REVIEW_STATE (need: APPROVED)"
            echo "  - Failing/pending checks: $CHECK_RUNS (need: 0)"
          fi

      - name: Auto-approve and merge PR
        if: steps.check-ready.outputs.ready == 'true'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üéâ Auto-merging PR #$PR_NUMBER..."

          # Merge PR with squash
          gh pr merge $PR_NUMBER \
            --repo $REPOSITORY \
            --squash \
            --auto \
            --delete-branch

          echo "‚úÖ PR merged successfully"
          echo "üóëÔ∏è  Branch will be deleted automatically"

          # Add success comment
          gh pr comment $PR_NUMBER --repo $REPOSITORY --body \
            "‚úÖ **Auto-merged**: All checks passed and review approved.

            ü§ñ Automated by Claude Code Review workflow"

      - name: Comment if not ready
        if: steps.check-ready.outputs.ready == 'false'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_STATE=$(gh pr view $PR_NUMBER --repo $REPOSITORY --json reviewDecision -q '.reviewDecision')
          HEAD_SHA=$(gh pr view $PR_NUMBER --repo $REPOSITORY --json headRefOid -q '.headRefOid')
          CHECK_RUNS=$(gh api "/repos/$REPOSITORY/commits/$HEAD_SHA/check-runs" \
            --jq '[.check_runs[] | select(.status != "completed" or .conclusion != "success")] | length')

          gh pr comment $PR_NUMBER --repo $REPOSITORY --body \
            "‚è≥ **Auto-merge pending**: Waiting for conditions to be met.

            **Current status:**
            - Review decision: \`$REVIEW_STATE\` (need: \`APPROVED\`)
            - Failing/pending checks: $CHECK_RUNS (need: 0)

            The PR will auto-merge once all conditions are satisfied.

            ü§ñ Automated by Claude Code Review workflow"
