# Migration Guide: v2.0 → 0.9.0-rc-1

**Version**: 0.9.0-rc-1
**Last Updated**: 2025-01-15
**Estimated Migration Time**: 30-60 minutes

---

## Overview

contextd 0.9.0-rc-1 is a complete architectural rebuild focused on context optimization, security, and modern observability. This guide helps you migrate from v2.0 to 0.9.0-rc-1 with minimal downtime.

### What Changed in 0.9.0-rc-1

**Major Changes**:
- ✅ HTTP server with Echo router (replaces Unix socket)
- ✅ JSON-RPC 2.0 protocol compliance
- ✅ YAML-based configuration (replaces command-line flags)
- ✅ Modular service architecture (checkpoint, remediation, prefetch)
- ✅ Pre-fetch engine (20-30% token savings)
- ✅ Secret scrubbing with Gitleaks (800+ patterns)
- ✅ OpenTelemetry traces and Prometheus metrics
- ✅ NATS JetStream for operation tracking

**Breaking Changes**:
1. **Transport**: Unix socket → HTTP server on port 8080
2. **Configuration**: Command-line flags → config.yaml + environment variables
3. **MCP Protocol**: stdio transport → HTTP
4. **Service Architecture**: Monolithic → Modular services

**Compatibility**:
- ✅ Qdrant data format unchanged (no re-indexing required)
- ✅ Vector embeddings compatible (1536-dimensional)
- ✅ Checkpoint and remediation data structures unchanged
- ✅ MCP tool names unchanged (same 9 tools)

### New Features in 0.9.0-rc-1

**Pre-Fetch Engine** (NEW):
- Automatic context loading on git events (branch switch, commits)
- 3 deterministic rules: branch_diff, recent_commit, common_files
- 5-minute TTL cache with LRU eviction
- 8 Prometheus metrics for performance tracking
- Estimated 20-30% token savings for git workflows

**Secret Scrubbing** (NEW):
- Gitleaks integration (800+ secret patterns)
- 5-layer defense architecture
- Redaction in logs, responses, and error messages
- Claude Code hook integration

**Observability** (NEW):
- OpenTelemetry distributed tracing
- Prometheus metrics (prefetch, MCP operations)
- Health check endpoints
- Structured logging with zap

**HTTP Protocol** (NEW):
- JSON-RPC 2.0 compliance
- NATS JetStream for async operation tracking
- Better error handling and debugging

---

## Breaking Changes

### 1. HTTP Server (was: Unix socket)

**v2.0 Behavior**:
```bash
# Unix socket at fixed location
contextd --socket /tmp/contextd.sock
```

**0.9.0-rc-1 Behavior**:
```bash
# HTTP server on configurable port
contextd --config config.yaml
# Defaults to http://localhost:8080
```

**Migration Impact**:
- MCP client configuration must be updated (see Step 7)
- Health checks now use HTTP endpoint: `curl http://localhost:8080/health`
- No more socket file permissions (replaced by Bearer token auth)

---

### 2. Configuration Format

**v2.0 Configuration** (command-line flags):
```bash
contextd \
  --socket /tmp/contextd.sock \
  --token-path ~/.contextd/token \
  --embedding-url http://localhost:8080/v1 \
  --embedding-model BAAI/bge-small-en-v1.5
```

**0.9.0-rc-1 Configuration** (YAML file):
```yaml
# ~/.config/contextd/config.yaml
server:
  port: 8080
  shutdown_timeout: 10s

observability:
  enable_telemetry: true
  service_name: contextd-v3

prefetch:
  enabled: true
  cache_ttl: 5m
  cache_max_entries: 100
```

**Migration Impact**:
- Create `~/.config/contextd/config.yaml` with your settings
- Environment variables still work (override YAML)
- Command-line flags removed (except `--config`, `--version`, `--help`)

---

### 3. MCP Protocol

**v2.0 MCP Transport** (stdio):
```json
{
  "mcpServers": {
    "contextd": {
      "command": "contextd-mcp-server",
      "args": []
    }
  }
}
```

**0.9.0-rc-1 MCP Transport** (HTTP):
```json
{
  "mcpServers": {
    "contextd": {
      "url": "http://localhost:8080/mcp",
      "transport": {
        "type": "http"
      }
    }
  }
}
```

**Migration Impact**:
- Claude Code MCP configuration must be updated
- JSON-RPC 2.0 error responses (better error handling)

---

### 4. Service Architecture

**v2.0 Architecture** (monolithic):
```
contextd binary
  └── Single service with all functionality
```

**0.9.0-rc-1 Architecture** (modular):
```
contextd binary
  ├── HTTP Server (Echo router)
  ├── Vector Core (langchaingo + Qdrant)
  ├── Checkpoint Service
  ├── Remediation Service
  ├── Pre-Fetch Service (NEW)
  ├── Secret Scrubbing (NEW)
  └── Observability (OpenTelemetry)
```

**Migration Impact**:
- No user-facing changes (internal architecture)
- Better error isolation (service failures don't crash server)
- Improved testability and maintainability

---

## Migration Steps

### Step 1: Backup v2.0 Data

**CRITICAL**: Always back up your data before migration.

```bash
# Stop v2.0 service
systemctl --user stop contextd    # Linux
sudo launchctl unload ~/Library/LaunchAgents/com.dahendel.contextd.plist  # macOS

# Backup Qdrant data (if using Docker)
docker exec qdrant tar czf /tmp/qdrant-backup.tar.gz /qdrant/storage
docker cp qdrant:/tmp/qdrant-backup.tar.gz ./qdrant-backup-$(date +%Y%m%d).tar.gz

# Backup configuration (v2.0)
cp ~/.config/contextd/config.yaml ~/.config/contextd/config.yaml.v2.0.backup

# Backup logs
cp -r ~/.config/contextd/logs ~/.config/contextd/logs.v2.0.backup
```

**Verify Backup**:
```bash
# Check backup file size
ls -lh qdrant-backup-*.tar.gz

# Should be >1MB if you have data
```

---

### Step 2: Stop v2.0 Services

**Linux (systemd)**:
```bash
systemctl --user stop contextd
systemctl --user disable contextd
```

**macOS (launchd)**:
```bash
sudo launchctl unload ~/Library/LaunchAgents/com.dahendel.contextd.plist
sudo rm ~/Library/LaunchAgents/com.dahendel.contextd.plist
```

**Docker Services** (Qdrant, TEI):
```bash
# Keep Qdrant and TEI running (0.9.0-rc-1 uses same services)
docker-compose ps

# If not running, start dependencies
docker-compose up -d qdrant tei
```

---

### Step 3: Update Dependencies

**Pull 0.9.0-rc-1 Code**:
```bash
cd /path/to/contextd
git fetch origin
git checkout feature/v3-rebuild  # Or 0.9.0-rc-1 tag when released

# Update Go dependencies
go mod download
```

**Update Docker Compose** (if using):
```bash
# 0.9.0-rc-1 adds NATS JetStream for operation tracking
docker-compose up -d

# Verify services
docker-compose ps

# Expected:
# - qdrant (running)
# - tei (running)
# - nats (running) ← NEW in 0.9.0-rc-1
```

---

### Step 4: Create Configuration File

**Create config.yaml**:
```bash
# Create config directory
mkdir -p ~/.config/contextd

# Create config file
cat > ~/.config/contextd/config.yaml <<'EOF'
# contextd 0.9.0-rc-1 Configuration

# HTTP Server
server:
  port: 8080
  shutdown_timeout: 10s

# OpenTelemetry Observability
observability:
  enable_telemetry: true
  service_name: contextd-v3

# Pre-Fetch Engine (NEW in 0.9.0-rc-1)
prefetch:
  enabled: true
  cache_ttl: 5m
  cache_max_entries: 100

  rules:
    branch_diff:
      enabled: true
      max_files: 10
      max_size_kb: 50
      timeout_ms: 1000

    recent_commit:
      enabled: true
      max_size_kb: 20
      timeout_ms: 500

    common_files:
      enabled: true
      max_files: 3
      timeout_ms: 500
EOF
```

**Set Environment Variables** (if using TEI embeddings):
```bash
# Add to ~/.bashrc or ~/.zshrc
export EMBEDDING_BASE_URL=http://localhost:8080/v1
export EMBEDDING_MODEL=BAAI/bge-small-en-v1.5
export EMBEDDING_DIM=1536

# Reload shell
source ~/.bashrc  # or source ~/.zshrc
```

---

### Step 5: Build and Run 0.9.0-rc-1

**Build contextd**:
```bash
cd /path/to/contextd
go build -o contextd ./cmd/contextd/

# Verify build
./contextd --version

# Expected output:
# contextd 0.9.0-rc-1 (commit: abc1234, built: 2025-01-15T10:30:00Z)
```

**Run contextd** (foreground for testing):
```bash
# Run with config file
./contextd --config ~/.config/contextd/config.yaml

# Expected output:
# INFO  server  HTTP server starting  {"port": 8080}
# INFO  prefetch.detector  Pre-fetch engine initialized
# INFO  server  Server ready  {"url": "http://localhost:8080"}
```

---

### Step 6: Verify Migration

**Health Check**:
```bash
# Check HTTP endpoint
curl http://localhost:8080/health

# Expected:
# {"status":"ok","version":"0.9.0-rc-1","uptime":"5s"}
```

**Test MCP Status Endpoint**:
```bash
# Test JSON-RPC 2.0 status call
curl -X POST http://localhost:8080/mcp/status \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": "1",
    "method": "status",
    "params": {}
  }'

# Expected:
# {
#   "jsonrpc": "2.0",
#   "id": "1",
#   "result": {
#     "services": {
#       "checkpoint": "ready",
#       "remediation": "ready",
#       "prefetch": "ready"
#     }
#   }
# }
```

**Verify Qdrant Connection**:
```bash
# Check Qdrant collections
curl http://localhost:6333/collections

# Expected: List of collections (checkpoints, remediations, etc.)
```

---

### Step 7: Update Claude Code MCP Configuration

**Locate Claude Code Config**:
```bash
# Linux
~/.claude.json

# macOS
~/Library/Application Support/Claude/claude_desktop_config.json
```

**Update MCP Server Configuration**:

**Before (v2.0 - stdio transport)**:
```json
{
  "mcpServers": {
    "contextd": {
      "command": "/usr/local/bin/contextd-mcp-server",
      "args": []
    }
  }
}
```

**After (0.9.0-rc-1 - HTTP transport)**:
```json
{
  "mcpServers": {
    "contextd": {
      "url": "http://localhost:8080/mcp",
      "transport": {
        "type": "http"
      },
      "headers": {
        "Content-Type": "application/json"
      }
    }
  }
}
```

**Restart Claude Code**:
- Completely quit Claude Code (Cmd+Q on macOS, Ctrl+Q on Linux)
- Restart Claude Code
- Verify MCP server appears in available tools

---

### Step 8: Test MCP Tools

**Test Checkpoint Save**:
```
In Claude Code:
/checkpoint save "testing 0.9.0-rc-1 migration"
```

**Expected Response**:
```
✓ Checkpoint saved successfully
ID: abc123
Timestamp: 2025-01-15T10:45:00Z
```

**Test Checkpoint Search**:
```
In Claude Code:
/checkpoint search "migration"
```

**Expected Response**:
```
Found 1 checkpoint:
1. [10:45] testing 0.9.0-rc-1 migration (similarity: 0.95)
```

**Test Pre-Fetch** (if enabled):
```bash
# 1. Switch branches in terminal
cd /path/to/indexed/project
git checkout feature/new-feature

# 2. Wait 2-3 seconds for pre-fetch

# 3. Ask Claude Code:
"What changed in this branch?"

# Expected: Instant response with diff summary (from pre-fetch cache)
```

---

### Step 9: Install systemd/launchd Service (Optional)

**Linux (systemd)**:
```bash
# Create systemd service file
cat > ~/.config/systemd/user/contextd.service <<'EOF'
[Unit]
Description=contextd 0.9.0-rc-1 - Context Daemon for Claude Code
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/contextd --config %h/.config/contextd/config.yaml
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=default.target
EOF

# Reload systemd
systemctl --user daemon-reload

# Enable and start
systemctl --user enable contextd
systemctl --user start contextd

# Check status
systemctl --user status contextd
```

**macOS (launchd)**:
```bash
# Create launchd plist
cat > ~/Library/LaunchAgents/com.axyzlabs.contextd.plist <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.axyzlabs.contextd</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/contextd</string>
        <string>--config</string>
        <string>~/.config/contextd/config.yaml</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardErrorPath</key>
    <string>/tmp/contextd.log</string>
    <key>StandardOutPath</key>
    <string>/tmp/contextd.log</string>
</dict>
</plist>
EOF

# Load service
launchctl load ~/Library/LaunchAgents/com.axyzlabs.contextd.plist

# Check status
launchctl list | grep contextd
```

---

## Rollback Plan

If migration fails or 0.9.0-rc-1 has critical issues, roll back to v2.0:

### Step 1: Stop 0.9.0-rc-1 Service

```bash
# Stop contextd 0.9.0-rc-1
killall contextd

# Or stop systemd/launchd service
systemctl --user stop contextd  # Linux
launchctl unload ~/Library/LaunchAgents/com.axyzlabs.contextd.plist  # macOS
```

### Step 2: Restore v2.0 Data (if modified)

```bash
# Restore Qdrant backup (if data corrupted)
docker stop qdrant
docker cp qdrant-backup-20250115.tar.gz qdrant:/tmp/
docker exec qdrant tar xzf /tmp/qdrant-backup-20250115.tar.gz -C /
docker start qdrant
```

### Step 3: Checkout v2.0 Code

```bash
cd /path/to/contextd
git checkout main  # v2.0 branch

# Rebuild
go build -o contextd ./cmd/contextd/
```

### Step 4: Restore v2.0 Configuration

```bash
# Restore old config
cp ~/.config/contextd/config.yaml.v2.0.backup ~/.config/contextd/config.yaml

# Restore Claude Code MCP config (stdio transport)
# Edit ~/.claude.json and revert to stdio transport
```

### Step 5: Restart v2.0 Service

```bash
# Linux
systemctl --user start contextd

# macOS
launchctl load ~/Library/LaunchAgents/com.dahendel.contextd.plist
```

### Step 6: Verify v2.0 Works

```bash
# Check health (v2.0 socket-based check)
ctxd health

# Test MCP tools in Claude Code
```

---

## FAQ

### Q: Will I lose my checkpoints during migration?

**A**: No. Qdrant data format is unchanged. Your checkpoints, remediations, and indexed repositories remain intact. However, **always backup** before migrating.

---

### Q: Do I need to re-index repositories?

**A**: No. Vector embeddings and collection schema are compatible. Existing indexes work in 0.9.0-rc-1 without re-indexing.

---

### Q: Can I run v2.0 and 0.9.0-rc-1 simultaneously?

**A**: No. Both versions use the same Qdrant instance and would conflict. If you need to test 0.9.0-rc-1, use a separate Qdrant instance or migrate fully.

---

### Q: What happens to my TEI embeddings?

**A**: TEI embedding service is unchanged. 0.9.0-rc-1 uses the same TEI Docker container and API. No reconfiguration needed.

---

### Q: Do I need to update my API keys?

**A**: No. Environment variables like `OPENAI_API_KEY` (if using OpenAI embeddings) remain the same. 0.9.0-rc-1 reads the same environment variables as v2.0.

---

### Q: How do I disable pre-fetch if I don't want it?

**A**: Set `prefetch.enabled: false` in config.yaml or export `PREFETCH_ENABLED=false`.

---

### Q: What if my migration fails?

**A**: Follow the [Rollback Plan](#rollback-plan) to restore v2.0. Report issues on [GitHub](https://github.com/axyzlabs/contextd/issues) with:
- Migration step where failure occurred
- Error messages from logs
- System information (OS, Go version, Docker versions)

---

### Q: Is there downtime during migration?

**A**: Yes, minimal downtime (5-10 minutes) while you:
1. Stop v2.0 service
2. Build and configure 0.9.0-rc-1
3. Start 0.9.0-rc-1 service
4. Update Claude Code MCP config

Plan migration during low-usage periods if possible.

---

### Q: How do I verify pre-fetch is working?

**A**: See [PREFETCH-USER-GUIDE.md](./PREFETCH-USER-GUIDE.md#verify-its-working) for detailed verification steps.

---

### Q: What are the system requirements for 0.9.0-rc-1?

**A**: Same as v2.0:
- **Memory**: 512MB minimum, 2GB recommended
- **Disk**: 1GB for Qdrant data + logs
- **CPU**: 2 cores minimum
- **OS**: Linux (amd64/arm64), macOS (amd64/arm64)
- **Docker**: For Qdrant, TEI, NATS services

---

### Q: Do I need NATS for 0.9.0-rc-1?

**A**: NATS JetStream is used for operation tracking in 0.9.0-rc-1. It's **optional** but recommended. If NATS is unavailable, 0.9.0-rc-1 gracefully degrades (no async progress updates).

---

## Getting Help

### Documentation

- **Pre-Fetch User Guide**: [PREFETCH-USER-GUIDE.md](./PREFETCH-USER-GUIDE.md)
- **v3 Specification**: [docs/specs/v3-rebuild/SPEC.md](../../specs/v3-rebuild/SPEC.md)
- **Configuration Guide**: [config.yaml](../../config.yaml)

### Support Channels

- **GitHub Issues**: [github.com/axyzlabs/contextd/issues](https://github.com/axyzlabs/contextd/issues)
- **Discussions**: [github.com/axyzlabs/contextd/discussions](https://github.com/axyzlabs/contextd/discussions)
- **Documentation**: [docs/](../../)

### Reporting Migration Issues

When reporting migration issues, include:
1. **Step where failure occurred** (e.g., "Step 5: Build failed")
2. **Error messages** (full logs from `journalctl` or log files)
3. **System info**: `uname -a`, `go version`, `docker --version`
4. **Config file**: Sanitized `config.yaml` (remove secrets)
5. **Health check output**: `curl http://localhost:8080/health`

---

**Last Updated**: 2025-01-15
**Version**: 0.9.0-rc-1
