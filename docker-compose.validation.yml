version: '3.8'

services:
  # Qdrant vector database for integration testing
  qdrant:
    image: qdrant/qdrant:v1.8.3
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - validation

  # Test runner container
  validation-tests:
    build:
      context: .
      dockerfile: Dockerfile.validation
    depends_on:
      qdrant:
        condition: service_healthy
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6334
      - GO_TEST_FLAGS=-v -race
      - LOG_LEVEL=debug
    volumes:
      - .:/workspace
      - go-cache:/go/pkg/mod
    working_dir: /workspace
    command: >
      sh -c "
        echo 'ðŸ” Running production hardening validation tests...' &&
        go test ./internal/vectorstore -run TestProductionHardening -v -race -timeout 5m &&
        echo 'âœ… All validation tests passed!'
      "
    networks:
      - validation

  # Stress test runner for concurrent scenarios
  stress-tests:
    build:
      context: .
      dockerfile: Dockerfile.validation
    depends_on:
      qdrant:
        condition: service_healthy
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6334
      - STRESS_TEST_DURATION=30s
      - STRESS_TEST_WORKERS=100
    volumes:
      - .:/workspace
      - go-cache:/go/pkg/mod
    working_dir: /workspace
    command: >
      sh -c "
        echo 'ðŸ”¥ Running stress tests...' &&
        go test ./internal/vectorstore -run TestStress -v -race -timeout 2m
      "
    networks:
      - validation
    profiles:
      - stress

volumes:
  qdrant_data:
  go-cache:

networks:
  validation:
    driver: bridge
