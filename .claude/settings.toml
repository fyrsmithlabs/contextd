# Claude Code Settings and Hooks Configuration
# This file configures automation hooks for contextd development

# Test automation on Go file changes
[[hooks]]
event = "PostToolUse"
[hooks.matcher]
tool_name = "write_file"
file_paths = ["**/*.go"]
command = "go test ./... && go fmt $FILE"
background = true

# Pre-commit validation
[[hooks]]
event = "PreToolUse"
[hooks.matcher]
tool_name = "git_commit"
command = ".scripts/pre-task-complete.sh"

# Coverage check on test changes
[[hooks]]
event = "PostToolUse"
[hooks.matcher]
tool_name = "write_file"
file_paths = ["**/*_test.go"]
command = "go test -coverprofile=coverage.out ./... && go tool cover -func=coverage.out | grep total"
background = true

# Spec existence check on new package files
[[hooks]]
event = "PreToolUse"
[hooks.matcher]
tool_name = "write_file"
file_paths = ["pkg/**/*.go"]
command = '''
PKG=$(dirname "$FILE" | cut -d'/' -f2)
SPEC="docs/specs/${PKG}.md"
if [[ ! -f "$SPEC" ]]; then
  echo "⚠️  No spec found: $SPEC"
  echo "Run: /create-spec-issue $PKG"
fi
'''

# Linting on Go file save
[[hooks]]
event = "PostToolUse"
[hooks.matcher]
tool_name = "write_file"
file_paths = ["**/*.go"]
command = "golint $FILE && go vet $FILE"
background = true

# Error detection and research suggestion
[[hooks]]
event = "PostToolUse"
[hooks.matcher]
tool_name = "bash"
command = '''
if [[ $TOOL_OUTPUT == *"error"* ]] || [[ $TOOL_OUTPUT == *"FAIL"* ]]; then
  echo "⚠️  Error detected. Consider using @agent-research-analyst to search for solutions."
  echo "Then write a resolution proposal spec in docs/specs/resolutions/"
fi
'''

# Security check on credential-related files
[[hooks]]
event = "PreToolUse"
[hooks.matcher]
tool_name = "write_file"
file_paths = ["**/token", "**/api_key", "**/*.env"]
command = '''
echo "⚠️  SECURITY WARNING: Writing credential file: $FILE"
echo "Ensure file permissions are set to 0600"
chmod 0600 "$FILE" 2>/dev/null || echo "Failed to set permissions"
'''

# Context efficiency reminder at 70%
[[hooks]]
event = "Notification"
[hooks.matcher]
notification_type = "context_window_warning"
command = '''
echo "⚠️  CONTEXT AT 70%: Use checkpoint+clear NOW"
echo "NEVER use /compact (30-60s). ALWAYS use checkpoint+clear (<2s)"
echo "Example: /checkpoint save 'brief summary' && /clear"
'''

# Auto-checkpoint on significant changes
[[hooks]]
event = "PostToolUse"
[hooks.matcher]
tool_name = "git_commit"
command = '''
echo "✅ Commit successful. Consider creating checkpoint:"
echo "/checkpoint save 'Committed: <brief description>'"
'''
background = true
